#!/bin/bash

printUsage()
{
    cat <<HELPTEXT
Pickaxe: git show / log (according to GIT-COMMAND) where text or /regexp/ was changed.
HELPTEXT
    printf 'Usage: %q %s\n' "$(basename "$1")" 'GIT-COMMAND [<options>] [<since>..<until>] [[--] <path>...] text|/regexp/ [-?|-h|--help]'
}
case "$1" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
esac
gitCommand=${1:?}; shift
lastArg=${!#}
case "$lastArg" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
esac

if [ $# -eq 0 ]; then
    printUsage "$0"
    exit 2
fi

# The last argument is the text or /regexp/.
case "$lastArg" in
    # Check for no arguments given to findchanges, findlogsv and findlg aliases.
    -p|--pretty=oneline|--name-status)
	printUsage "$0"
	exit 2
	;;
esac

searchString=$(printf '%s' "$lastArg" | sed -ne 's/^\([^a-zA-Z0-9]\)\(.*\)\1$/\2/p')
[ "$searchString" ] && allargs+=("--pickaxe-regex") || searchString=$lastArg

exec git-wrapper "$gitCommand" "${@:1:$(($#-1))}" "-S$searchString"
