#!/bin/bash
set -o pipefail

printShortUsage()
{
    local distributionArguments='[--no-footer|--final-footer-only|footer-only-on-change|--footer-every N] [--as colorbox-calendar|green-[large-]calendar|...] [--weekly]'
    local logArguments='[<log-options>] [<revision range>] [[--] <path>...]'
    # Note: short followed by long option; if the user knows the short one, she can
    # skim the long one.
    printf 'Usage: %q %s %s %s\n' "$(basename "$1")" "$distributionArguments" "$logArguments" '[-?|-h|--help]'
    echo
    printf 'Usage: %q %s %s | %q --stdin %s\n' "$(basename "$1")" '--log-only' "$logArguments" "$(basename "$1")" "$distributionArguments"
}
printUsage()
{
    # This is the short help when launched with no or incorrect arguments.
    # It is printed to stderr to avoid accidental processing.
    printShortUsage "$1" >&2
    printf >&2 '\nTry %q --help for more information.\n' "$(basename "$1")"
}
printLongUsage()
{
    # This is the long "man page" when launched with the help argument.
    # It is printed to stdout to allow paging with 'more'.
    cat <<HELPDESCRIPTION
Print the distribution of the number of commits that fall into the logged range.
Depending on the span of time during which the commits were authored, this will
be the distribution over the day, month, or over year(s) (for anything longer).
HELPDESCRIPTION
    echo
    printShortUsage "$1"
    echo
    cat <<HELPTEXT
SEE ALSO:
- git log
- distribution-over-autorange
HELPTEXT
}

action=printGraphFromObtainedLogs
typeset -a distributionArgs=()
typeset -a gitArgs=()
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printLongUsage "$0"; exit 0;;
	--log-only)	shift; action=getLogs;;
	--stdin)	shift; action=printGraphFromInput;;

	--no-footer|--final-footer-only|--footer-only-on-change|--weekly)
			distributionArgs+=("$1"); shift;;
	--footer-every|--as)
			distributionArgs+=("$1" "$2"); shift; shift;;

	--pretty|--pretty=*|--format|--format=*)
			echo >&2 'ERROR: Cannot influence the log format via --pretty|--format.'
			echo >&2
			printUsage "$0" >&2
			exit 2
			;;
	--)		gitArgs+=("$1"); shift; break;;
	*)		gitArgs+=("$1"); shift;;
    esac
done
gitArgs+=("$@")

getLogs()
{
    git log --pretty=tformat:'%ai' "${gitArgs[@]}"
}

printGraphFromObtainedLogs()
{
    # The logged dates still need to be sorted, because sorting happens by commit
    # date, but we'd like to show the author date distribution. The
    # --split-graph-field would be disturbed by an earlier date reappeared after a
    # later date again.
    getLogs | sort --numeric-sort | printGraph
}

printGraphFromInput()
{
    sort --numeric-sort | printGraph
}

printGraph()
{
    distribution-over-autorange "${distributionArgs[@]}"
}

$action
