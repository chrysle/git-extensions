#!/bin/bash
set -o pipefail

ensureValidRef()
{
    if ! git-existsbr "$1"; then
	printf >&2 'ERROR: Branch %s does not exist!\n' "$1"
	exit 1
    fi
}

if [ $# -eq 2 ]; then
    localBranch=$1
    remoteBranch=$2
elif [ $# -eq 1 ]; then
    localBranch=$(git-brname --real-branch-only) || exit $?
    case "$1" in
	*/*)	remoteBranch=$1;;
	*)	remoteBranch=$(git-remotebr "$1") || exit $?;;
    esac
else
    localBranch=$(git-brname --real-branch-only) || exit $?
    remoteBranch=$(git tracks) || exit $?
fi

typeset -a pager=("${PAGER:-less}" --RAW-CONTROL-CHARS); [ -t 1 ] || pager=()
ensureValidRef "$localBranch"
ensureValidRef "$remoteBranch"

gitColorArg=()
[ -n "$pager" ] && isNeedColorArgumentWhenPiping "$@" && gitColorArg=(--color=always)

inout()
{
    echo "incoming ${remoteBranch} -> ${localBranch}:"
    git-onelinelog --no-pager "${gitColorArg[@]}" "$localBranch..$remoteBranch"

    echo
    echo "outgoing ${localBranch} -> ${remoteBranch}:"
    git-onelinelog --no-pager "${gitColorArg[@]}" "$remoteBranch..$localBranch"
}
eval 'inout "$@"' "${pager:+|}" '"${pager[@]}"'
