#!/bin/bash

remote="${1:?}"; shift
url=$(git-remoteurl "$remote") || exit $?

if [ "$1" = '--' ]; then
    shift
elif rev="$(git-commitid --no-error "$1")"; then
    shift
    [ "$1" = '--' ] && shift
fi
[ "$rev" ] || rev=HEAD

for filespec
do
    # XXX: Git 2.7.4 gives an error when trying to expand an alias in a
    # subdirectory of a worktree;
    # cp. https://bugzilla.redhat.com/show_bug.cgi?id=1377440
    # Expand the "lh" alias into the effective log command.
    #hash="$(git lh --max-count 1 "$rev" -- "$filespec")"
    hash="$(git log --pretty=tformat:%H --max-count 1 "$rev" -- "$filespec")"
    git-lll --prefix "${url%/}/blob/${hash}/" --transform 'urlencode --filespec --newlines -' --no-classify "$filespec"
done
