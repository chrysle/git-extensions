#!/bin/bash
shopt -qs extglob

printUsage()
{
    cat <<HELPTEXT
List all local (sorted by last commit age (descending, starting with branches
that haven't been updated recently)) / passed branches (except for the current
branch and master (and base branch if defined)).
HELPTEXT
    printf 'Usage: %q %s\n' "$(basename "$1")" '[--include-current] [--include-master] [--include-base] [--include-all] [--] [<branch1> ...] [-?|-h|--help]'
}
getBranches()
{
    if [ $# -gt 0 ]; then
	printf '%s\n' "$@"
    else
	git for-each-ref --sort=committerdate --format='%(refname:short)' refs/heads/
    fi
}

typeset -a branchFilters=()
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	    shift; printUsage "$0"; exit 0;;
	--include-*)	    branchFilters+=("$1"); shift;;
	--)		    shift; break;;
	-*)		    { echo "ERROR: Unknown option \"$1\"!"; echo; printUsage "$0"; } >&2; exit 2;;
	*)		    break;;
    esac
done

getBranches "$@" | \
    git-filter-out-persistent-branches "${branchFilters[@]}"
