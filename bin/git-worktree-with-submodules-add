#!/bin/bash

printUsage()
{
    cat <<HELPTEXT
Short textual description.
HELPTEXT
    echo
    printf 'Usage: %q %s\n' "$(basename "$1")" '<path> [-?|-h|--help]'
}
case "$1" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
esac
if [ $# -ne 1 ]; then
    printUsage "$0" >&2
    exit 2
fi

targetDirspec="$(realpath --no-symlinks -- "${PWD}/${1:?}")" || exit 3
if [ -e "$targetDirspec" ]; then
    printf >&2 'ERROR: Worktree target already exists: %s\n' "$targetDirspec"
    exit 1
fi

add()
{
    local moduleName="${1:?}"; shift
    local moduleDirspec="${1:?}"; shift
    git -C "modules/$moduleName" worktree add --detach "$moduleDirspec"
}

git worktree add --detach "$targetDirspec" || exit $?
cd "$(git rev-parse --git-dir)" || exit $?
IFS=$'\n'
status=0
for module in $(git config --blob HEAD:.gitmodules -l --name-only | awk -F . '/\.path$/ { print $2 }')
do
    if [ -d "modules/$module" ]; then
	modulePath="$(git config --blob HEAD:.gitmodules --get "submodule.${module}.path")" && \
	    $action "$module" "${targetDirspec}/${modulePath}" || \
	    status=$?
    fi
done
exit $status
